name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (for example v0.2.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "Expected a tag starting with 'v' (got '$TAG')." >&2
            exit 1
          fi

          VERSION="${TAG#v}"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.4

      - name: Grant gradlew permissions
        run: chmod +x gradlew

      - name: Run backend checks
        run: ./gradlew clean ktlintCheck test

      - name: Run frontend checks
        working-directory: frontend
        run: |
          npm ci
          npm run lint
          npm run format:check
          npm run test
          npm run build

      - name: Build backend jar (versioned)
        env:
          DWARVENPICK_VERSION: ${{ steps.version.outputs.version }}
        run: ./gradlew :backend:app:bootJar

      - name: Package Helm chart (versioned)
        run: |
          mkdir -p dist
          helm package deploy/helm/dwarvenpick \
            --destination dist \
            --version "${{ steps.version.outputs.version }}" \
            --app-version "${{ steps.version.outputs.version }}"

      - name: Collect artifacts
        shell: bash
        run: |
          cp backend/app/build/libs/*.jar dist/
          ls -lah dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/*
