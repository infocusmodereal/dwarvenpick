apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "dwarvenpick.fullname" . }}
  labels:
    app.kubernetes.io/name: {{ include "dwarvenpick.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  {{- if not .Values.hpa.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "dwarvenpick.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "dwarvenpick.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      serviceAccountName: {{ include "dwarvenpick.serviceAccountName" . }}
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- range .Values.image.pullSecrets }}
        - name: {{ . | quote }}
        {{- end }}
      {{- end }}
      containers:
        - name: backend
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: {{ .Values.env.SPRING_PROFILES_ACTIVE | quote }}
            - name: SERVER_PORT
              value: {{ .Values.env.SERVER_PORT | quote }}
            - name: DWARVENPICK_CREDENTIAL_ACTIVE_KEY_ID
              value: {{ .Values.credentials.activeKeyId | quote }}
            - name: DWARVENPICK_EXTERNAL_DRIVERS_DIR
              value: {{ ternary .Values.drivers.external.mountPath .Values.env.DWARVENPICK_EXTERNAL_DRIVERS_DIR .Values.drivers.external.enabled | quote }}
            - name: DWARVENPICK_DRIVERS_MAVEN_ENABLED
              value: {{ .Values.drivers.maven.enabled | quote }}
            - name: DWARVENPICK_DRIVERS_MAVEN_REPOSITORY_URL
              value: {{ .Values.drivers.maven.repositoryUrl | quote }}
            - name: DWARVENPICK_DRIVERS_MAVEN_MAX_JAR_SIZE_MB
              value: {{ .Values.drivers.maven.maxJarSizeMb | quote }}
            - name: DWARVENPICK_SEED_ENABLED
              value: {{ .Values.env.DWARVENPICK_SEED_ENABLED | quote }}
            - name: DWARVENPICK_AUTH_LOCAL_ENABLED
              value: {{ .Values.env.DWARVENPICK_AUTH_LOCAL_ENABLED | quote }}
            - name: DWARVENPICK_AUTH_LDAP_ENABLED
              value: {{ .Values.env.DWARVENPICK_AUTH_LDAP_ENABLED | quote }}
            - name: DWARVENPICK_AUTH_LDAP_URL
              value: {{ .Values.env.DWARVENPICK_AUTH_LDAP_URL | quote }}
            - name: DWARVENPICK_AUTH_LDAP_BIND_DN
              value: {{ .Values.env.DWARVENPICK_AUTH_LDAP_BIND_DN | quote }}
            - name: DWARVENPICK_AUTH_LDAP_BIND_PASSWORD
              value: {{ .Values.env.DWARVENPICK_AUTH_LDAP_BIND_PASSWORD | quote }}
            - name: DWARVENPICK_AUTH_LDAP_USER_SEARCH_BASE
              value: {{ .Values.env.DWARVENPICK_AUTH_LDAP_USER_SEARCH_BASE | quote }}
            - name: DWARVENPICK_AUTH_LDAP_GROUP_SYNC_GROUP_SEARCH_BASE
              value: {{ .Values.env.DWARVENPICK_AUTH_LDAP_GROUP_SYNC_GROUP_SEARCH_BASE | quote }}
            - name: DWARVENPICK_METRICS_PROMETHEUS_ENABLED
              value: {{ .Values.metrics.prometheus.enabled | quote }}
            {{- range $key, $value := .Values.extraEnv }}
            - name: {{ $key | quote }}
              value: {{ $value | quote }}
            {{- end }}
            {{- if .Values.credentials.masterKey.existingSecret }}
            - name: DWARVENPICK_CREDENTIAL_MASTER_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.credentials.masterKey.existingSecret | quote }}
                  key: {{ .Values.credentials.masterKey.key | quote }}
            {{- else if .Values.credentials.masterKey.value }}
            - name: DWARVENPICK_CREDENTIAL_MASTER_KEY
              value: {{ .Values.credentials.masterKey.value | quote }}
            {{- end }}
          {{- if .Values.envFromSecrets }}
          envFrom:
            {{- range .Values.envFromSecrets }}
            - secretRef:
                name: {{ . | quote }}
            {{- end }}
          {{- end }}
          {{- if .Values.drivers.external.enabled }}
          volumeMounts:
            - name: external-drivers
              mountPath: {{ .Values.drivers.external.mountPath | quote }}
              readOnly: {{ .Values.drivers.external.readOnly }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: http
            initialDelaySeconds: {{ .Values.probes.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.liveness.periodSeconds }}
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: http
            initialDelaySeconds: {{ .Values.probes.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.readiness.periodSeconds }}
      {{- if .Values.drivers.external.enabled }}
      volumes:
        - name: external-drivers
          {{- if .Values.drivers.external.existingClaim }}
          persistentVolumeClaim:
            claimName: {{ .Values.drivers.external.existingClaim | quote }}
          {{- else if .Values.drivers.external.createPvc }}
          persistentVolumeClaim:
            claimName: {{ printf "%s-external-drivers" (include "dwarvenpick.fullname" .) | quote }}
          {{- else }}
          emptyDir: {}
          {{- end }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
